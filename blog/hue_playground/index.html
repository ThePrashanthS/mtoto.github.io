<!DOCTYPE html>
<html lang="en-us">

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer">
<meta name="description" content="Coding with Data">

<base href="../../">
<title>


     hue_playground 

</title>
<link rel="canonical" href="../../blog/hue_playground/">


<script type="text/javascript">
    var baseURL = '\/';
    var host = baseURL.substring(0, baseURL.length - 1).replace(/\//g, '');
    if ((host === window.location.host) && (window.location.protocol !== 'https:')) {
        window.location.protocol = 'https:';
    }
</script>




    <link rel="stylesheet" href="../../css/vs.css">
    <script src="../../js/highlight.pack.js"></script>
    <script>
  hljs.initHighlightingOnLoad();
    </script>







    
    <link rel="stylesheet" href="../../css/reset.css?t=1503766492">
    <link rel="stylesheet" href="../../css/pygments.css?t=1503766492">
    <link rel="stylesheet" href="../../css/main.css?t=1503766492">
    
        <link rel="stylesheet" href="../../css/override.css?t=1503766492">
    




<link rel="shortcut icon"

    href="../../img/leaf.ico"

>






</head>


<body lang="en">

<section class="header">
    <div class="container">
        <div class="content">
            
              <a href="../../"><img class="avatar" src="../../img/profile_pic.png" /></a>
            
            <a href="../../"><div class="name">Tamas Szilagyi</div></a>
            
              <h3 class="self-intro">Coding with Data</h3>
            
            <nav>
                <ul>
                    <a href="../../blog/"><li>Blog</li></a>
                    <a href="../../about/"><li>About</li></a>
                </ul>
            </nav>
        </div>
    </div>
</section>

<section class="icons">
    <div class="container">
        <div class="content">
            
        
            <a href="mailto:tszilagyi@outlook.com"><img class="icon" src="../../img/email.svg" alt="email" /></a>
        
            
        
            <a href="//linkedin.com/in/tszilagyi" target="_blank"><img class="icon" src="../../img/linkedin.svg" alt="linkedin" /></a>
        
            
        
            <a href="//twitter.com/tudosgar" target="_blank"><img class="icon" src="../../img/twitter.svg" alt="twitter" /></a>
        

        
            <a href="//github.com/mtoto" target="_blank"><img class="icon" src="../../img/github.svg" alt="github" /></a>
        
            
        
            <a href="//stackoverflow.com/users/4964651/mtoto?tab=profile" target="_blank"><img class="icon" src="../../img/so.svg" alt="stackoverflow" /></a>
        


        

        
            <a href="//soundcloud.com/tamas-szilagyi" target="_blank"><img class="icon" src="../../img/soundcloud.svg" alt="soundcloud" /></a>
        

        

       
        </div>
    </div>
</section>
    


<section class="main post non-narrow zero-top-spacing">
    <div class="container">
        <div class="content">
            <div class="front-matter">
                <div class="title-container">
                    <div class="page-heading">

    hue_playground

</div>

                    <div class="initials"><a href="../../"></a></div>
                </div>
                <div class="meta">
                    <div class="date" title="Mon Jan 1 0001 00:00:00 UTC">Jan 1, 0001</div>
                    <div class="reading-time"><div class="middot"></div>6 minutes read</div>
                </div>
            </div>
            <div class="markdown">
                <div id="smarter-lights" class="section level2">
<h2>Smarter lights</h2>
<p>My original inspiration for this post was <a href="https://sc5.io/posts/autonomous-indoor-lighting-using-neural-networks/">Max Pagel’s article</a> on using neural networks to automatically control his Philips Hue lights. In fact, I purchased my first set of Hue bulbs because of it. Perhaps I too can create my very own smart devices I thought.</p>
<p>Nowadays, it only takes a few lines of <code>R</code> code to create and expose prediction models as an <code>API</code>. In particular, I will rely on the <a href="https://topepo.github.io/caret/">caret</a> package for modeling and on <a href="https://cran.r-project.org/web/packages/jug/vignettes/jug.html">jug</a> to create a prediction API.</p>
</div>
<div id="tidying-up-and-exploring" class="section level2">
<h2>Tidying up and exploring</h2>
<p>Much like in my post on <a href="http://tamaszilagyi.com/blog/creating-a-spotify-playlist-using-luigi/">Spotify</a> I have set up a cronjob to execute the Python script that pings the API and saves the data to Amazon S3 - you can find the functions on my Github. The starting point for this post will be the parsed <code>.json</code> file containing the log data for my “Dinner Lamps”. They are basically the main lights in my living room at the moment hanging above my dinner table.</p>
<pre class="r"><code>library(aws.s3)
library(jsonlite)</code></pre>
<pre><code>## Loading required package: methods</code></pre>
<pre class="r"><code># read file from amazon
aws.signature::use_credentials()
df &lt;- s3read_using(object = paste0(&quot;hue_full_2017-08-26.json&quot;),
                   fromJSON, bucket = &quot;ams-hue-data&quot;)
str(df)</code></pre>
<pre><code>## &#39;data.frame&#39;:    30322 obs. of  15 variables:
##  $ on.1       : logi  FALSE FALSE FALSE FALSE FALSE FALSE ...
##  $ on.2       : logi  FALSE FALSE FALSE FALSE FALSE FALSE ...
##  $ bri.2      : int  131 131 131 131 131 131 131 131 131 131 ...
##  $ type.1     : chr  &quot;Dimmable light&quot; &quot;Dimmable light&quot; &quot;Dimmable light&quot; &quot;Dimmable light&quot; ...
##  $ type.2     : chr  &quot;Dimmable light&quot; &quot;Dimmable light&quot; &quot;Dimmable light&quot; &quot;Dimmable light&quot; ...
##  $ bri.1      : int  131 131 131 131 131 131 131 131 131 131 ...
##  $ modelid.2  : chr  &quot;LWB010&quot; &quot;LWB010&quot; &quot;LWB010&quot; &quot;LWB010&quot; ...
##  $ modelid.1  : chr  &quot;LWB010&quot; &quot;LWB010&quot; &quot;LWB010&quot; &quot;LWB010&quot; ...
##  $ name.1     : chr  &quot;Dinner Lamp 2&quot; &quot;Dinner Lamp 2&quot; &quot;Dinner Lamp 2&quot; &quot;Dinner Lamp 2&quot; ...
##  $ reachable.1: logi  TRUE TRUE TRUE TRUE TRUE TRUE ...
##  $ reachable.2: logi  TRUE TRUE TRUE TRUE TRUE TRUE ...
##  $ name.2     : chr  &quot;Dinner Lamp 1&quot; &quot;Dinner Lamp 1&quot; &quot;Dinner Lamp 1&quot; &quot;Dinner Lamp 1&quot; ...
##  $ alert.1    : chr  &quot;none&quot; &quot;none&quot; &quot;none&quot; &quot;none&quot; ...
##  $ log_time   : chr  &quot;2017-05-12 17:00:02&quot; &quot;2017-05-12 17:05:01&quot; &quot;2017-05-12 17:10:02&quot; &quot;2017-05-12 17:15:01&quot; ...
##  $ alert.2    : chr  &quot;none&quot; &quot;none&quot; &quot;none&quot; &quot;none&quot; ...</code></pre>
<p>The structure of the original <code>.json</code> file is such that for each lamp has a separate (numbered) column for every variable. The dataset is essentially a timeseries where each row represent a snapshot of the lamps’ state at <code>log_time</code>, or <strong>every 5 minutes</strong>. Before we move on to visualisations and modeling, let’s tidy things up a bit.</p>
<pre class="r"><code>library(tidyr)
tidy_df &lt;- df %&gt;% gather(key, value, -log_time) %&gt;%
        separate(key, into = c(&quot;variable&quot;, &quot;lamp&quot;), sep = &quot;\\.&quot;) %&gt;%
        spread(variable, value)
str(tidy_df)</code></pre>
<pre><code>## &#39;data.frame&#39;:    60644 obs. of  9 variables:
##  $ log_time : chr  &quot;2017-05-12 17:00:02&quot; &quot;2017-05-12 17:00:02&quot; &quot;2017-05-12 17:05:01&quot; &quot;2017-05-12 17:05:01&quot; ...
##  $ lamp     : chr  &quot;1&quot; &quot;2&quot; &quot;1&quot; &quot;2&quot; ...
##  $ alert    : chr  &quot;none&quot; &quot;none&quot; &quot;none&quot; &quot;none&quot; ...
##  $ bri      : chr  &quot;131&quot; &quot;131&quot; &quot;131&quot; &quot;131&quot; ...
##  $ modelid  : chr  &quot;LWB010&quot; &quot;LWB010&quot; &quot;LWB010&quot; &quot;LWB010&quot; ...
##  $ name     : chr  &quot;Dinner Lamp 2&quot; &quot;Dinner Lamp 1&quot; &quot;Dinner Lamp 2&quot; &quot;Dinner Lamp 1&quot; ...
##  $ on       : chr  &quot;FALSE&quot; &quot;FALSE&quot; &quot;FALSE&quot; &quot;FALSE&quot; ...
##  $ reachable: chr  &quot;TRUE&quot; &quot;TRUE&quot; &quot;TRUE&quot; &quot;TRUE&quot; ...
##  $ type     : chr  &quot;Dimmable light&quot; &quot;Dimmable light&quot; &quot;Dimmable light&quot; &quot;Dimmable light&quot; ...</code></pre>
<p>The 15 columns are now reduced to 9 because each variable appears only once thanks to adding a new key column <code>lamp</code> to the dataset. We will try to predict is <code>$bri</code>, or brightness of the lamps binned into four categories. Because when the lamp is not <code>on</code> nor <code>reachable</code>, brightness should be set at 0. Then we convert <code>$log_time</code> to type <code>POSIXct</code> and add the <code>$y</code> - the binned brightess variable.</p>
<pre class="r"><code>library(dplyr)</code></pre>
<pre><code>## 
## Attaching package: &#39;dplyr&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:stats&#39;:
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from &#39;package:base&#39;:
## 
##     intersect, setdiff, setequal, union</code></pre>
<pre class="r"><code>binned_df &lt;- tidy_df %&gt;% mutate(bri = replace(bri, on==&quot;FALSE&quot; | reachable==&quot;FALSE&quot;,0) %&gt;% 
                               as.numeric(),
                       log_time =  as.POSIXct(log_time, tz = &quot;Europe/Amsterdam&quot;),
                       y = as.factor(ifelse(bri == 0, &quot;zero&quot;,
                                            ifelse(between(bri,0,80), &quot;dim&quot;,
                                                   ifelse(between(bri,80,160),&quot;mid&quot;,&quot;bright&quot;)))))</code></pre>
<p>Let’s look at the distribution of our target variable.</p>
<pre class="r"><code>table(binned_df$y) </code></pre>
<pre><code>## 
## bright    dim    mid   zero 
##   1176   3106   3446  52916</code></pre>
<p>Almost 90% of the times the lamps are off, resulting in an unbalanced dataset. What abour brightess values lamps were <em>on</em>?</p>
<pre class="r"><code>library(ggplot2)
binned_df %&gt;% filter(bri != 0 ) %&gt;%
        ggplot(., aes(bri)) +
        geom_histogram(bins = 15)</code></pre>
<p><img src="../../blog/2017/2017-05-14-hue_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>The distribution looks a seems to be close to normal with a positive skew, and a massive outlier all the way at the end of the spectrum. That’s maximum brightness, the default when I switch the lights on/off with a physical switch.</p>
<p>Before moving on to modeling, we end with lookin at the density distributions of brightness according to the categories we defined earlier:</p>
<pre class="r"><code>binned_df %&gt;% filter(bri != 0) %&gt;%
        ggplot(., aes(bri, fill = y, alpha = .5)) +
        geom_density() +
        guides(alpha = FALSE) + 
        ggtitle(&quot;Distribution of brightness categories&quot;)</code></pre>
<p><img src="../../blog/2017/2017-05-14-hue_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
</div>
<div id="modeling" class="section level2">
<h2>Modeling</h2>
<p>Next, let’s make a simple model as quickly as possible. The aim here is not to create a perfect model, but one that’s good enough to put into production and easily iterated upon.</p>
<p>There were days, I wasn’t home. We’ll omit such days not to confuse the model more than my already irregular usage patterns.</p>
<pre class="r"><code>off_days &lt;- binned_df %&gt;% group_by(date = as.Date(log_time,tz=&quot;Europe/Amsterdam&quot;)) %&gt;%
                dplyr::summarise(total_bri = sum(bri)) %&gt;%
                filter(total_bri == 0 ) %&gt;%
                select(date)</code></pre>
<p>The only features I will use, will be time based.</p>
<ul>
<li>Day of the week</li>
<li>Month</li>
<li>Week number</li>
<li>Weekend or not</li>
<li>Time of the day - morning, afternoon etc.</li>
<li>Minutes since 12PM, 6AM, 12AM and 6PM.</li>
</ul>
<pre class="r"><code>df_vars &lt;- binned_df %&gt;% filter(lamp == &quot;1&quot; &amp; !as.Date(log_time) %in% off_days$date) %&gt;%
        select(log_time, y) %&gt;% 
        mutate(date = as.Date(log_time,tz=&quot;Europe/Amsterdam&quot;),
               mins_passed = as.numeric(difftime(log_time, 
                                                 as.POSIXct(paste0(date,&quot;00:00:00&quot;), 
                                                            tz = &quot;Europe/Amsterdam&quot;),
                                                 units=&quot;mins&quot;) %&gt;% round()),
               day_of_week = factor(weekdays(date),
                                    levels = c(&quot;Monday&quot;, &quot;Tuesday&quot;, &quot;Wednesday&quot;,
                                               &quot;Thursday&quot;, &quot;Friday&quot;, &quot;Saturday&quot;, 
                                               &quot;Sunday&quot;)),
               month = lubridate::month(date),
               week = lubridate::week(date),
               weekend = factor(ifelse(day_of_week %in% c(&quot;Friday&quot;,&quot;Saturday&quot;,&quot;Sunday&quot;), 
                                       &quot;weekend&quot;, &quot;weekday&quot;)),
               hour = lubridate::hour(log_time),
               time_of_day = factor(ifelse(hour &gt; 5 &amp; hour &lt; 12, &quot;morning&quot;,
                                           ifelse(hour &gt; 11 &amp; hour &lt; 18, &quot;afternoon&quot;,
                                                  ifelse(hour &gt; 17 &amp; hour &lt; 24, &quot;evening&quot;,
                                                         &quot;night&quot;)))),
               mins_cut = ifelse(time_of_day==&quot;morning&quot;, mins_passed - 360,
                                 ifelse(time_of_day==&quot;afternoon&quot;, mins_passed - 720,
                                        ifelse(time_of_day==&quot;evening&quot;, mins_passed - 1080, mins_passed)))) %&gt;% 
        select(-log_time, -mins_passed, -hour)</code></pre>
</div>
<div id="binned-ideas" class="section level1">
<h1>Binned ideas</h1>
<p>draw brightness value randomly from the value distribution in each bucket!!</p>
</div>

                <br>
                <p><a href="../../blog/">Back to posts</a></p>
            </div>
            <br>
            <div class="disqus">
                <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'Tamas';
    var disqus_identifier = '\/blog\/hue_playground\/';
    var disqus_title = 'hue_playground';
    var disqus_url = '\/blog\/hue_playground\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
        </div>
    </div>
</section>

   <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
    });
    </script>
    <script type="text/javascript"
      src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>



<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-97386385-1', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>



  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
  
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/languages/r.min.js"></script>
  

  <script type="text/javascript">
    hljs.initHighlightingOnLoad();
  </script>






<link rel="stylesheet" href="//css/vs.css">
<script src="../../js/highlight.pack.js"></script>
<script>
  hljs.initHighlightingOnLoad();
</script>

